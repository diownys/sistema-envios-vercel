<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vendas Concluídas</title>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script> 
    
    <style>
        body { font-family: sans-serif; background-color: #f4f4f9; margin: 0; padding: 1rem; }
        .container { max-width: 1200px; margin: auto; }
        .header { margin-bottom: 1.5rem; }
        .header a { color: #007bff; text-decoration: none; font-weight: bold; }
        h1 { color: #333; }
        .vendas-table { width: 100%; border-collapse: collapse; margin-top: 1rem; }
        .vendas-table th, .vendas-table td { border: 1px solid #ddd; padding: 0.75rem; text-align: left; }
        .vendas-table th { background-color: #e9ecef; }
        .loading-status, .no-data { text-align: center; color: #555; padding: 2rem; }
        .pagination-controls { display: flex; justify-content: center; align-items: center; gap: 1rem; margin-top: 1rem; }
        .pagination-controls button { padding: 0.5rem 1rem; cursor: pointer; border-radius: 5px; border: 1px solid #ccc; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <a href="/index.html">← Voltar ao Dashboard</a>
        </div>
        <h1>Vendas Concluídas (Confirmadas)</h1>

        <div id="loading-status" class="loading-status">Carregando vendas...</div>
        
        <table class="vendas-table" id="vendas-table" style="display: none;">
            <thead>
                <tr>
                    <th>Data Coleta</th>
                    <th>Janela</th>
                    <th>Cód. Venda</th>
                    <th>Cliente</th>
                    <th>Vendedor</th>
                </tr>
            </thead>
            <tbody id="vendas-tbody">
                </tbody>
        </table>

        <div class="pagination-controls">
            <button id="prev-page" disabled>← Anterior</button>
            <span id="page-info">Página 1 de 1</span>
            <button id="next-page" disabled>Próxima →</button>
        </div>
    </div>

<script>
    // ✅ INICIALIZAÇÃO LOCAL (COMO NOS DEMAIS ARQUIVOS)
    const SUPABASE_URL = 'https://nfsuisftzddegihyhoha.supabase.co'; 
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5mc3Vpc2Z0emRkZWdpaHlob2hhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkwMTcwMDcsImV4cCI6MjA3NDU5MzAwN30.tM_9JQo6ejzOBWKQ9XxT54f8NuM6jSoHomF9c_IfEJI';
    
    const { createClient } = window.supabase;
    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    // ----------------------------------------------------------------------

    const ITEMS_PER_PAGE = 20;
    let currentPage = 0;
    let totalPages = 1;

    const vendasTbody = document.getElementById('vendas-tbody');
    const loadingStatus = document.getElementById('loading-status');
    const vendasTable = document.getElementById('vendas-table');
    const prevPageButton = document.getElementById('prev-page');
    const nextPageButton = document.getElementById('next-page');
    const pageInfoSpan = document.getElementById('page-info');

    function formatDateTime(isoString) {
        if (!isoString) return '';
        const date = new Date(isoString);
        return date.toLocaleDateString('pt-BR');
    }

    function updatePaginationControls() {
        pageInfoSpan.textContent = `Página ${currentPage + 1} de ${totalPages}`;
        prevPageButton.disabled = currentPage === 0;
        nextPageButton.disabled = currentPage >= totalPages - 1;
    }

    async function fetchVendasConcluidas() {
        loadingStatus.textContent = "Carregando vendas...";
        vendasTable.style.display = 'none';

        try {
            // 1. Contar o total de vendas concluídas (status = 'confirmado')
            let countQuery = supabase
                .from('vendas')
                .select('*', { count: 'exact', head: true })
                .eq('status_coleta', 'confirmado');
            
            const { count, error: countError } = await countQuery;
            
            if (countError) throw countError;
            
            totalPages = Math.ceil(count / ITEMS_PER_PAGE);
            if (currentPage >= totalPages) currentPage = Math.max(0, totalPages - 1);
            
            updatePaginationControls();

            // 2. Buscar as vendas da página atual
            const from = currentPage * ITEMS_PER_PAGE;
            const to = from + ITEMS_PER_PAGE - 1;

            const { data: vendas, error } = await supabase
                .from('vendas')
                .select('data_coleta, janela_coleta, cod_venda, cliente, vendedor')
                .eq('status_coleta', 'confirmado')
                .order('data_coleta', { ascending: false })
                .order('janela_coleta', { ascending: true })
                .range(from, to);

            if (error) throw error;

            vendasTbody.innerHTML = '';
            if (vendas.length === 0) {
                loadingStatus.textContent = "Nenhuma venda concluída encontrada.";
            } else {
                vendas.forEach(venda => {
                    const row = vendasTbody.insertRow();
                    row.insertCell().textContent = formatDateTime(venda.data_coleta);
                    row.insertCell().textContent = venda.janela_coleta;
                    row.insertCell().textContent = venda.cod_venda;
                    row.insertCell().textContent = venda.cliente;
                    row.insertCell().textContent = venda.vendedor;
                });
                loadingStatus.style.display = 'none';
                vendasTable.style.display = 'table';
            }

        } catch (error) {
            console.error("Erro ao buscar vendas concluídas:", error.message);
            loadingStatus.textContent = `Erro ao carregar vendas: ${error.message}. Verifique o Console (F12).`;
            vendasTable.style.display = 'none';
        }
    }

    document.addEventListener('DOMContentLoaded', async () => {
        // Verifica Autenticação
        const { data: { session } } = await supabase.auth.getSession();
        if (!session) {
            window.location.href = '/login.html';
            return;
        }

        // Carrega dados
        fetchVendasConcluidas();

        // Listeners de Paginação
        prevPageButton.addEventListener('click', () => {
            if (currentPage > 0) {
                currentPage--;
                fetchVendasConcluidas();
            }
        });

        nextPageButton.addEventListener('click', () => {
            if (currentPage < totalPages - 1) {
                currentPage++;
                fetchVendasConcluidas();
            }
        });
    });
</script>
</body>
</html>
