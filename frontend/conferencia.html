<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Conferência - Sistema de Envios</title>

    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>

    <style>
        body { font-family: sans-serif; background-color: #f4f4f9; display: flex; justify-content: center; align-items: center; min-height: 100vh; margin: 0; padding: 2rem 0; }
        .conferencia-container { background: white; padding: 2rem 3rem; border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); text-align: center; width: 100%; max-width: 600px; }
        h1 { color: #333; margin-bottom: 1.5rem; }
        h2 { color: #555; margin-bottom: 1rem; border-top: 1px solid #eee; padding-top: 1.5rem; }

        #scanner { width: 100%; max-width: 500px; margin: 0 auto; border: 1px solid #ddd; border-radius: 8px; overflow: hidden; }
        .resultado-message { color: #dc3545; margin-top: 1rem; min-height: 1.2em; font-size: 1.1rem; font-weight: bold; }
        #lista-conferencia { text-align: left; margin-top: 1rem; }

        .item-venda { padding: 12px; border: 1px solid #ddd; margin-bottom: 8px; border-radius: 5px; display: flex; align-items: center; transition: background-color 0.3s; }
        .status { display: inline-block; width: 15px; height: 15px; border-radius: 50%; margin-right: 12px; flex-shrink: 0; }
        .pendente { background-color: orange; }
        .concluido { background-color: #28a745; }
        .item-venda span { font-size: 0.9rem; color: #666; margin-left: auto; }

        /* Estilos Admin e Botões */
        #manual-input-container { display: none; margin-top: 1.5rem; border-top: 1px solid #eee; padding-top: 1.5rem; text-align: left; }
        #manual-input-container label { display: block; margin-bottom: 0.5rem; color: #555; }
        #manual-qrcode { width: 100%; padding: 0.8rem; border: 1px solid #ddd; border-radius: 5px; box-sizing: border-box; }
        #manual-submit { width: 100%; padding: 0.9rem; background-color: #6c757d; color: white; border: none; border-radius: 5px; font-size: 1rem; font-weight: bold; cursor: pointer; transition: background-color 0.2s; margin-top: 0.5rem; }
        #reset-lote-btn { width: 100%; padding: 0.9rem; background-color: #dc3545; color: white; border: none; border-radius: 5px; font-size: 1rem; font-weight: bold; cursor: pointer; margin-top: 0.5rem; }
        #gerar-romaneio-btn { width: 100%; padding: 0.9rem; background-color: #007bff; color: white; border: none; border-radius: 5px; font-size: 1rem; font-weight: bold; cursor: pointer; transition: background-color 0.2s; }
    </style>
</head>
<body>

<div class="conferencia-container">
    <h1>Conferência de Lote</h1>
    
    <div id="scanner"></div>
    <div id="resultado" class="resultado-message"></div>

    <div id="manual-input-container">
        <label for="manual-qrcode">Entrada Manual (Admin)</label>
        <input type="text" id="manual-qrcode" placeholder="Digite o QR Code..."/>
        <button id="manual-submit">Conferir Manualmente</button>
        <button id="reset-lote-btn">Resetar Lote</button>
    </div>

    <h2>Lista de Conferência (Realtime)</h2>
    <div id="romaneio-container" style="margin-bottom: 1rem;"></div>
    <div id="lista-conferencia">Carregando lista...</div>
</div>

<script>
    const { createClient } = window.supabase;

    // === CONFIGURAÇÃO ===
    const SUPABASE_URL = 'https://nfsuisftzddegihyhoha.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5mc3Vpc2Z0emRkZWdpaHlob2hhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkwMTcwMDcsImV4cCI6MjA3NDU5MzAwN30.tM_9JQo6ejzOBWKQ9XxT54f8NuM6jSoHomF9c_IfEJI';
    
    // Variável unificada para evitar conflito com a biblioteca
    const supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    
    const urlParams = new URLSearchParams(window.location.search);
    const LOTE_ID_PARA_TESTAR = urlParams.get('lote_id'); 
    
    if (!LOTE_ID_PARA_TESTAR) {
        alert("ID do Lote não encontrado! Retornando para a seleção.");
        window.location.href = '/selecao-lote.html'; 
    }

    // Referências dos Elementos
    const divLista = document.getElementById('lista-conferencia');
    const divResultado = document.getElementById('resultado');
    const manualInputContainer = document.getElementById('manual-input-container');
    const manualInput = document.getElementById('manual-qrcode');
    const manualSubmit = document.getElementById('manual-submit');
    const romaneioContainer = document.getElementById('romaneio-container');

    // ===== FUNÇÃO RENDERIZAR LISTA =====
    async function renderizarLista() {
        const { data, error } = await supabaseClient.rpc('get_status_conferencia_lote', {
            p_lote_id: LOTE_ID_PARA_TESTAR
        });
        
        if (error) { divLista.innerHTML = "Erro ao buscar lista."; return; }
        if (!data || data.length === 0) { divLista.innerHTML = "Nenhum item encontrado."; return; }

        let html = '';
        let todosConcluidos = true;

        data.forEach(item => {
            const isConcluido = item.volumes_conferidos === item.volumes_totais;
            if (!isConcluido) todosConcluidos = false;
            
            const statusClass = isConcluido ? 'concluido' : 'pendente';
            html += `
                <div class="item-venda" style="${isConcluido ? 'background-color: #f0fff4;' : ''}">
                    <span class="status ${statusClass}"></span>
                    <strong>${item.venda_numero_display}</strong> 
                    (${item.cliente_nome_display || 'Cliente'})
                    <span>${item.volumes_conferidos} / ${item.volumes_totais}</span>
                </div>`;
        });
        divLista.innerHTML = html;

        // Botão Romaneio
        if (todosConcluidos && data.length > 0) {
            romaneioContainer.innerHTML = `
                <p style="color: #28a745; font-weight: bold;">Todos os itens conferidos!</p>
                <button id="gerar-romaneio-btn">Gerar Romaneio</button>
            `;
            document.getElementById('gerar-romaneio-btn').onclick = async () => {
                const btn = document.getElementById('gerar-romaneio-btn');
                btn.disabled = true;
                btn.innerText = 'Gerando...';

                try {
                    const { data: htmlRomaneio, error } = await supabaseClient.functions.invoke('gerar-romaneio-lote', {
                        body: { lote_id: LOTE_ID_PARA_TESTAR }
                    });
                    if (error) throw error;

                    const printWindow = window.open('', '_blank');
                    printWindow.document.write(htmlRomaneio);
                    printWindow.document.close();
                    btn.innerText = 'Gerar Romaneio';
                } catch (err) {
                    alert(`Erro ao gerar romaneio: ${err.message}`);
                } finally {
                    btn.disabled = false;
                }
            };
        } else {
            romaneioContainer.innerHTML = "";
        }
    }

    // ===== SCANNER SUCCESS =====
    async function onScanSuccess(qrCodeLido) {
        divResultado.style.color = '#007bff'; 
        divResultado.innerHTML = `Lido: ${qrCodeLido}. Processando...`;

        try {
            const { data, error } = await supabaseClient.functions.invoke('conferir-volume', {
                body: { qr_code: qrCodeLido, lote_id: LOTE_ID_PARA_TESTAR }
            });

            if (error) throw error;

            divResultado.style.color = '#28a745'; 
            divResultado.innerHTML = `SUCESSO: ${data.message}`;
            manualInput.value = '';
        } catch (err) {
            divResultado.style.color = '#dc3545'; 
            divResultado.innerHTML = `ERRO: ${err.message}`;
        }
    }

    // ===== REALTIME =====
    function escutarRealtime() {
        supabaseClient.channel('conferencia-changes')
        .on('postgres_changes', { 
            event: 'UPDATE', 
            schema: 'public', 
            table: 'volumes_conferencia' 
        }, () => {
            renderizarLista(); 
        })
        .subscribe();
    }

    // ===== ADMIN CHECK =====
    async function checkUserRole() {
        const { data: { session } } = await supabaseClient.auth.getSession();
        if (!session) { window.location.href = '/login.html'; return; }
        
        const { data: profile } = await supabaseClient
            .from('profiles')
            .select('role')
            .eq('id', session.user.id)
            .single();

        if (profile?.role === 'admin') {
            manualInputContainer.style.display = 'block';
            document.getElementById('reset-lote-btn').onclick = async () => {
                if (!confirm('Resetar lote? Todos voltarão para pendente.')) return;
                const { data, error } = await supabaseClient.rpc('resetar_lote_conferencia', { 
                    p_lote_id: LOTE_ID_PARA_TESTAR 
                });
                if (error) alert(error.message);
                else { divResultado.innerHTML = data; renderizarLista(); }
            };
        }
    }

    // Eventos de entrada manual
    manualSubmit.onclick = () => {
        const qr = manualInput.value.trim();
        if (qr) onScanSuccess(qr);
        else divResultado.innerHTML = "Campo vazio.";
    };

    manualInput.addEventListener('keydown', (e) => { if (e.key === 'Enter') manualSubmit.click(); });

    // Inicializar Scanner
    const html5QrCode = new Html5Qrcode("scanner");
    html5QrCode.start(
        { facingMode: "environment" },
        { fps: 10, qrbox: { width: 250, height: 250 } },
        onScanSuccess
    ).catch(err => {
        document.getElementById("scanner").innerHTML = "Erro na câmera: " + err.message;
    });

    // Início
    checkUserRole(); 
    renderizarLista(); 
    escutarRealtime(); 
</script>
</body>
</html>
